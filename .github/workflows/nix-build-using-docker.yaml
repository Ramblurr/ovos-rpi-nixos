name: nix-build-on-demand-docker
on:
  push:
    branches:
      - main
    paths:
      - '**/*.nix'

jobs:
  build-dev-image:
    name: Build dev image
    runs-on: ubuntu-latest
    environment:
      name: dev
    steps:
    - uses: actions/checkout@v3.5.3
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      timeout-minutes: 12
      #- uses: cachix/install-nix-action@v22
      #  with:
      #    nix_path: nixpkgs=channel:nixos-23.05
      #    extra_nix_config: |
      #      extra-platforms = aarch64-linux
    - name: Build image
      run: sudo bash build.sh
        #- name: Check nix.conf
        #  run: cat /etc/nix/nix.conf
        #- name: Register binfmt
        #  run: |
        #    docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
        #- name: Test binfmt availability
        #  run: |
        #    cat /proc/sys/fs/binfmt_misc/qemu-aarch64
        #- name: Build SD Image
        #  run: |
        #    nix-build '<nixpkgs/nixos>'  \
        #      -A config.system.build.sdImage \
        #      -I nixos-config=./configuration.dev.sdImage.nix \
        #      --argstr system aarch64-linux \
        #      --option sandbox false
    - uses: actions/upload-artifact@v3
      with:
        name: sd-image.img
        path: '*.img'
